# AGENTS.md

Coding agent reference for `natura-gems-frontend`. Read this before making any changes.

## Stack

| Layer | Technology |
|---|---|
| Framework | TanStack Start (SSR/streaming) |
| Router | TanStack Router (file-based, `src/routes/`) |
| Server state | TanStack Query |
| Forms | TanStack Form + Zod |
| CMS | Sanity (Studio at `studio-natura-gems/`) |
| Auth/DB | Supabase (initialized, minimal use) |
| i18n | Paraglide — ES default, EN at `/en/*` |
| UI | shadcn/ui (new-york style, zinc base) + Tailwind v4 |
| Package manager | Bun |
| Linter/formatter | Biome (tabs, double quotes) |
| Deployment | Netlify |

## Commands

```bash
bun run dev        # Dev server on :3000  (NOT bun --bun run dev — Vite needs system Node)
bun run build      # Production build     (same reason)
bun run test       # Vitest
bun run lint       # Biome lint
bun run format     # Biome format
bun run check      # lint + format + organize imports
bunx --bun shadcn@latest add <component>   # Add shadcn component
```

## Key directories

```
src/
  routes/          # File-based routes — dot-nested: foo.bar.tsx → /foo/bar
  routes/api.*.ts  # API endpoints
  components/ui/   # shadcn components
  hooks/           # Custom React hooks
  lib/
    seo.ts         # buildMeta(), resolveSanityMeta(), all JSON-LD helpers
    constants.ts   # WHATSAPP_NUMBER, COMPANY_NAME, COMPANY_LOCATION, etc.
    utils.ts       # cn() and general utilities
    sanity/
      sanity.ts         # Sanity client + urlFor()
      sanity-queries.ts # queryOptions() factories for all Sanity documents
      sanity-types.ts   # TypeScript types for all Sanity documents
  data/
    page-data.ts        # prefetch* and use* hooks for all pages (Sanity)
    home-page-data.ts   # Home page-specific prefetch/hook
    demo-products.ts    # Demo emerald products (ecommerce TBD)
    demo-jewelry-products.ts
  server.ts        # Paraglide middleware — DO NOT change handler.fetch() call
  router.tsx       # Router configuration
  routeTree.gen.ts # AUTO-GENERATED by TanStack Router Vite plugin — never edit manually
studio-natura-gems/
  schemaTypes/
    objects/       # Reusable Sanity object types (e.g. seoMetadata)
    pages/         # Singleton page schemas (homePage, emeraldPage, about, faqPage, guide)
    sections/      # Shared section schemas (newsletterSection, whatsAppSection)
    index.ts       # Registers all schemas
public/
  sitemap.xml      # Manual sitemap with hreflang
  llms.txt         # Short GEO summary for AI crawlers
  llms-full.txt    # Detailed GEO content (~250 lines)
  robots.txt
  og-image.jpg     # 1200×630 Open Graph image
docs/
  geo-and-seo.md   # SEO/GEO strategy documentation
```

## Critical constraints — never violate

1. **Never edit config files**: `vite.config.ts`, `app.config.ts`, `tsconfig.json`,
   `netlify.toml` build/dev/redirect sections, `project.inlang/`, `src/paraglide/`.
2. **Never manually edit `src/routeTree.gen.ts`** — it regenerates on `bun run dev` / `bun run build`.
3. **`src/server.ts` Paraglide + TanStack Router integration**: The handler must pass
   the **original** request, NOT the middleware-delocalized one:
   `() => handler.fetch(req)` — not `({ request }) => handler.fetch(request)`.
   TanStack Router deLocalizes URLs itself via `rewrite.input`. Passing the
   already-delocalized `request` causes TanStack Router to issue self-referential
   307 redirects on all `/en/*` routes (infinite loop in the browser).
4. **`netlify.toml`**: Only `[[headers]]` blocks may be appended. Never touch `[build]`, `[dev]`,
   or `[[redirects]]` sections.
5. **Never auto-accept changes** — show the user a diff/summary and wait for confirmation.

## Known benign pre-existing issues (do not fix)

- `loaderData: never` TypeScript inference on child routes — caused by TanStack Router strict mode
  with `beforeLoad: async () => Promise<void>` on the root route. Cast as `(loaderData as Type | undefined)`.
- `id` static string lint warnings in some routes.
- `useEffect` dependency array warnings in `about.tsx` carousel.
- Index-as-key warnings in a few list renders.
- Build loop on first `bun run dev` when new route files are added — resolves on its own;
  Netlify production builds run clean.

## SEO / GEO patterns

### Adding meta to a route (static)

```tsx
import { buildMeta } from "@/lib/seo";

export const Route = createFileRoute("/my-page")({
  head: () =>
    buildMeta({
      title: "Page Title",           // appended: "Title | Natura Gems"
      description: "...",
      path: "/my-page",
      ogType: "website",             // or "article"
      noIndex: false,                // true for noindex pages
      jsonLd: [breadcrumbJsonLd(...)],
    }),
  component: MyPage,
});
```

### Adding meta driven by Sanity CMS

The loader must fetch from Sanity and return the SEO fields. `head()` then merges them with
`resolveSanityMeta()`, which lets editors override title/description/ogImage/noIndex in the Studio.

```tsx
import { buildMeta, resolveSanityMeta } from "@/lib/seo";
import { prefetchAboutPageData } from "@/data/page-data";
import type { SeoMetadata } from "@/lib/sanity/sanity-types";

export const Route = createFileRoute("/about")({
  head: ({ loaderData }) => {
    const seo = (loaderData as { seo?: SeoMetadata } | undefined)?.seo;
    return buildMeta(
      resolveSanityMeta(seo, {
        title: "Quiénes Somos",
        description: "Fallback description...",
        path: "/about",
        jsonLd: [breadcrumbJsonLd([...])],
      }),
    );
  },
  loader: async ({ context }) => {
    await prefetchAboutPageData(context.queryClient);
    const page = context.queryClient.getQueryData<{ seo?: SeoMetadata } | null>(
      ["sanity", "aboutPage"],
    );
    return { seo: page?.seo ?? null };
  },
  component: AboutPage,
});
```

### Available JSON-LD helpers (`src/lib/seo.ts`)

| Helper | Schema type |
|---|---|
| `organizationJsonLd()` | Organization |
| `localBusinessJsonLd()` | LocalBusiness + JewelryStore |
| `faqJsonLd(faqs)` | FAQPage |
| `breadcrumbJsonLd(items)` | BreadcrumbList |
| `howToJsonLd(opts)` | HowTo |
| `articleJsonLd(opts)` | Article |
| `emeraldItemListJsonLd(products)` | ItemList (emeralds) |
| `jewelryItemListJsonLd(products)` | ItemList (jewelry) |

## Sanity CMS

### Adding a new singleton page schema

1. Create `studio-natura-gems/schemaTypes/pages/myPage.ts`
2. Include the `seoMetadata` object field:
   ```ts
   import { seoMetadata } from "../objects";
   { name: "seo", title: "SEO", type: "object", fields: seoMetadata.fields }
   ```
3. Export from `studio-natura-gems/schemaTypes/pages/index.ts`
4. Register in `studio-natura-gems/schemaTypes/index.ts`
5. Add a `queryOptions()` factory in `src/lib/sanity/sanity-queries.ts` using `SEO_FRAGMENT`
6. Add a TypeScript interface in `src/lib/sanity/sanity-types.ts`
7. Add `prefetch*` and `use*` hooks in `src/data/page-data.ts`

### SEO fragment (used in all page GROQ queries)

```ts
const SEO_FRAGMENT = `
  seo {
    metaTitle,
    metaDescription,
    noIndex,
    ogImage { asset->{ _ref, url } }
  }
`;
```

### Sanity query key conventions

| Document | Query key |
|---|---|
| homePage | `["sanity", "homePage"]` |
| emeraldPage | `["sanity", "emeraldPage"]` |
| aboutPage | `["sanity", "aboutPage"]` |
| faqPage | `["sanity", "faqPage"]` |
| guides list | `["sanity", "guides"]` |
| guide by slug | `["sanity", "guide", slug]` |

## Route patterns

### Route file → URL mapping

| File | URL |
|---|---|
| `src/routes/index.tsx` | `/` |
| `src/routes/about.tsx` | `/about` |
| `src/routes/faq.tsx` | `/faq` |
| `src/routes/emeralds/index.tsx` | `/emeralds` |
| `src/routes/emeralds/collection.tsx` | `/emeralds/collection` |
| `src/routes/emeralds/tienda.tsx` | `/emeralds/tienda` |
| `src/routes/emeralds/compare.tsx` | `/emeralds/compare` (noIndex) |
| `src/routes/jewelry/index.tsx` | `/jewelry` |
| `src/routes/guides/index.tsx` | `/guides` |
| `src/routes/guides/$slug.tsx` | `/guides/:slug` |

### Loader + head() with loaderData

When `head()` needs data from the loader, the loader must **return** (not just await) the data,
and `head()` must cast `loaderData` because TanStack Router infers it as `never` on child routes:

```tsx
head: ({ loaderData }) => {
  const data = loaderData as MyType | undefined;
  // use data...
},
loader: async ({ context }) => {
  await prefetch(context.queryClient);
  const d = context.queryClient.getQueryData<MyType | null>(["sanity", "key"]);
  return { field: d?.field ?? null };   // must return, not just prefetch
},
```

## i18n

- Default language: Spanish (`es`), served at `/`
- English served at `/en/*`
- Translations live in `src/paraglide/` — **never edit manually**
- Route labels/links always use the Spanish path by default

## Environment variables

Required in `.env.local`:
```
VITE_SANITY_PROJECT_ID=...
VITE_SANITY_DATASET=...
VITE_SUPABASE_URL=...
VITE_SUPABASE_ANON_KEY=...
```

## GEO (Generative Engine Optimization)

Target AI engines: Google AI Overviews, Claude, ChatGPT/Bing Copilot, Perplexity.
Target audience: retail buyers, luxury shoppers, wholesale/B2B.

Key GEO assets:
- `public/llms.txt` — short summary for AI crawlers (do not update placeholder contact data)
- `public/llms-full.txt` — deep-dive content (~250 lines)
- JSON-LD on every page — signals authoritative entity data to AI crawlers
- FAQ content at `/faq` — 15 Q&As across 6 categories, `FAQPage` schema
- Guides at `/guides` and `/guides/:slug` — `Article` schema
